name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Cache Flutter packages
      uses: actions/cache@v3
      with:
        path: |
          ${{ runner.tool_cache }}/flutter
          ~/.pub-cache
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Analyze code
      run: flutter analyze
    
    - name: Run unit tests with coverage
      run: |
        flutter test --coverage --reporter=expanded
        if [ -f coverage/lcov.info ]; then
          curl -L https://github.com/dart-lang/lcov2lcov/raw/master/bin/lcov2lcov.dart \
            -o lcov2lcov.dart
          dart lcov2lcov.dart -i coverage/lcov.info -o coverage/test_coverage.lcov
        fi
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/test_coverage.lcov
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Check coverage threshold
      run: |
        total_coverage=$(grep -o 'lines.*[0-9.]*%' coverage/lcov.info | grep -o '[0-9.]*%' | head -1)
        echo "Total coverage: $total_coverage"
        if [ $(echo "$total_coverage >= 80" | bc -l) -eq 0 ]; then
          echo "Coverage $total_coverage is below 80%"
          exit 1
        fi

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Run integration tests
      run: |
        flutter test integration_test/ --reporter=expanded --no-pub
    
    - name: Run E2E tests (if configured)
      run: |
        # This would require a proper test environment
        # flutter test e2e/ --reporter=expanded --no-pub

  web-tests:
    name: Run Web Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Build web version
      run: flutter build web --web-renderer canvaskit
    
    - name: Test web build
      run: |
        # Verify the build was successful
        ls -la build/web/
        [ -f build/web/index.html ] || exit 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Run Flutter security check
      run: |
        # Check for known security vulnerabilities
        flutter pub deps --审计 --format=json | jq -r '.[] | select(.score < 0.5) | .name + " " + .version' || true
    
    - name: Check for hardcoded secrets
      run: |
        # Simple grep patterns for common secrets
        if grep -r "password\s*=" lib/ || \
           grep -r "api[_-]key\s*=" lib/ || \
           grep -r "secret\s*=" lib/; then
          echo "Potential hardcoded secrets found!"
          exit 1
        fi

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Run performance benchmarks
      run: |
        # Run tests with performance profiling
        flutter test test/ --reporter=expanded --no-pub --performance test-results.json
        # Analyze results
        if [ -f test-results.json ]; then
          echo "Performance test results available"
        fi

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, web-tests, security-scan, performance-tests]
    if: always()
    
    steps:
    - name: Check overall test status
      run: |
        if [[ "${{ needs.unit-tests.result }}" == "success" ]] && \
           [[ "${{ needs.integration-tests.result }}" == "success" ]] && \
           [[ "${{ needs.web-tests.result }}" == "success" ]] && \
           [[ "${{ needs.security-scan.result }}" == "success" ]] && \
           [[ "${{ needs.performance-tests.result }}" == "success" ]]; then
          echo "All tests passed! ✅"
        else
          echo "Some tests failed! ❌"
          echo "Unit tests: ${{ needs.unit-tests.result }}"
          echo "Integration tests: ${{ needs.integration-tests.result }}"
          echo "Web tests: ${{ needs.web-tests.result }}"
          echo "Security scan: ${{ needs.security-scan.result }}"
          echo "Performance tests: ${{ needs.performance-tests.result }}"
          exit 1
        fi

  build-release:
    name: Build Release
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Build Android APK
      run: |
        flutter build apk --release --dart-define=APP_ENV=production
    
    - name: Build iOS App (if on Mac)
      run: |
        if [[ "${{ runner.os }}" == "macOS" ]]; then
          flutter build ios --release --dart-define=APP_ENV=production
        else
          echo "Skipping iOS build on non-macOS runner"
        fi
    
    - name: Build Web
      run: |
        flutter build web --web-renderer canvaskit --dart-define=APP_ENV=production
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/web/
        retention-days: 30